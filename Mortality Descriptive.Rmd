---
title: "Mortality descriptive"
author: "Esther Chung"
date: "March 6, 2018"
output: word_document
editor_options: 
  chunk_output_type: console
---

Goal: Identify and explore mortality variables in the GHAP nutritional intervention trials. 

```{r}
rm(list=ls())
library(ghap)
library(knitr)
library(ggplot2)
library(dplyr)
library(haven)
# library(tidyverse)
```

```{r}
setwd("U:/data")

# Load data
aga <- readRDS("akup.rds")
bfzn <- readRDS("bfzn.rds")
dvds <- readRDS("dvds.rds") 
eczn <- readRDS("eczn.rds")
eu <- readRDS("eu.rds")
gbsc <- readRDS("gbsc.rds")
idose <- readRDS("ilnd.rds") 
idyad <- readRDS("ildm.rds")
ilzn <- readRDS("lnsz.rds")
jvit3 <- readRDS("jvt3.rds")
jvit4 <- readRDS("jvt4.rds")
lcni <- readRDS("lcn5.rds")
probit <- readRDS("prbt.rds")
sasfood <-readRDS("fspp.rds")
tanzchild <- readRDS("tzc2.rds")
# vita <- readRDS("")
# vitb12 <- readRDS("vb12.rds")
washbd <- readRDS("wsb.rds")
washk <- readRDS("wsk.rds")
znmort <- readRDS("zmrt.rds")
zvit <- readRDS("zvit.rds")
peruzn <- readRDS("pzn.rds")

# Vaccine trial
provide <- readRDS("prvd.rds") 
```

```{r}
# According to kikm_variables, the following studies have DEAD and AGEDTH as mortality variables 
  # DIVIDS, JIVITA, iDOSE, iDYAD, ZVITAMBO, TanzaniaChild2, PROVIDE

# DIVIDS
  table(dvds$DEAD)
  summary(dvds$AGEDTH)
  hist(dvds$AGEDTH)
  table(dvds$CAUSEDTH)
  table(dvds$CAUSDTHC)
  
# JiVitA-3
  jvit3$AGEDTH <- as.numeric(jvit3$AGEDTH)
  table(!is.na(d$AGEDTH))
  summary(jvit3$AGEDTH)
  
  #Check if age of death is recorded multiple times for each child who died
  jvit3 %>% group_by(SUBJID) %>% filter(!is.na(AGEDTH)) %>% summarize(N=n())

  #Looks like it is recorded once per subject


  #Check that the age of death is later than the oldest measurement on each child
  jvit3 <- jvit3 %>% group_by(SUBJID) %>% mutate(maxAge=max(AGEDAYS), deathErrorFlag= AGEDTH < AGEDAYS & !is.na(AGEDTH))
  
  table(jvit3$deathErrorFlag[!is.na(d$AGEDTH)])
  
  #Uh oh -5 children have measurements after there recorded age of death
  jvit3$AGEDAYS[jvit3$deathErrorFlag]
  jvit3$AGEDTH[jvit3$deathErrorFlag]
  
  jvit3[jvit3$deathErrorFlag,]
  
  #make indicator for any death
  jvit3 <- jvit3 %>% group_by(SUBJID) %>% mutate(died= any(!is.na(AGEDTH))) %>%
                 arrange(SUBJID, AGEDAYS)
  
  #subset data set to children who died
  df_death <- jvit3 %>% filter(died) %>% subset(., select=c(SUBJID, AGEDAYS, WHZ, AGEDTH, died))
  
  head(df_death, 20)
  
  
  #Check if anthropometry is measured when the age of death is recorded
  df_death$WHZ[!is.na(df_death$AGEDTH)]
  
  #Plot WHZ trajectories before death 
  ggplot(df_death) + geom_line(aes(x=AGEDAYS, y=WHZ, group=SUBJID), alpha=0.2) 
  
  
  #Smoothed WHZ trajectories before death and compare to those who didn't die
  ggplot(jvit3) + geom_smooth(aes(x=AGEDAYS, y=WHZ)) +
    facet_wrap(~died)
  
# JiVitA-4
  table(jvit4$DEAD)
  summary(jvit4$AGEDTH)
  hist(jvit4$AGEDTH)
  
# iLiNS-DOSE
  table(idose$DEAD)
  summary(idose$AGEDTH)
  hist(idose$AGEDTH)
  
# iLiNS-DYAD
  table(idyad$DEAD)
  summary(idyad$AGEDTH)
  hist(idyad$AGEDTH)
  
# TanzaniaChild2
  # Something weird here...
  summary(tanzchild$AGEDTH)
  hist(tanzchild$AGEDTH)
  
# ZVITAMBO
  summary(zvit$AGEDTH)
  hist(zvit$AGEDTH)
  table(zvit$CAUSEDTH)
  
# PROVIDE
  table(provide$DEAD)
  summary(provide$AGEDTH)
  hist(provide$AGEDTH)
```



